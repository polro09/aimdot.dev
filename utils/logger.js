// ========================================
// utils/logger.js - Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ
// ========================================
const chalk = require('chalk');
const fs = require('fs');
const path = require('path');

class Logger {
    constructor() {
        this.logTypes = {
            // ÏãúÏä§ÌÖú Í¥ÄÎ†®
            SYSTEM: { color: chalk.cyan, emoji: 'üîß', label: 'SYSTEM' },
            STARTUP: { color: chalk.magenta, emoji: 'üöÄ', label: 'STARTUP' },
            READY: { color: chalk.green, emoji: '‚úÖ', label: 'READY' },
            SHUTDOWN: { color: chalk.yellow, emoji: 'üõë', label: 'SHUTDOWN' },
            
            // Ï†ïÎ≥¥ÏÑ±
            INFO: { color: chalk.blue, emoji: 'üì¢', label: 'INFO' },
            SUCCESS: { color: chalk.green, emoji: '‚úÖ', label: 'SUCCESS' },
            WARNING: { color: chalk.yellow, emoji: '‚ö†Ô∏è', label: 'WARN' },
            ERROR: { color: chalk.red, emoji: '‚ùå', label: 'ERROR' },
            CRITICAL: { color: chalk.bgRed, emoji: 'üö®', label: 'CRITICAL' },
            
            // Î™®Îìà Í¥ÄÎ†®
            MODULE: { color: chalk.magenta, emoji: 'üì¶', label: 'MODULE' },
            MODULE_LOAD: { color: chalk.green, emoji: 'üì•', label: 'MODULE_LOAD' },
            MODULE_UNLOAD: { color: chalk.yellow, emoji: 'üì§', label: 'MODULE_UNLOAD' },
            MODULE_ERROR: { color: chalk.red, emoji: 'üî¥', label: 'MODULE_ERROR' },
            
            // Ïù¥Î≤§Ìä∏ Í¥ÄÎ†®
            EVENT: { color: chalk.cyan, emoji: '‚ö°', label: 'EVENT' },
            COMMAND: { color: chalk.blue, emoji: 'üéÆ', label: 'COMMAND' },
            BUTTON: { color: chalk.green, emoji: 'üîò', label: 'BUTTON' },
            DROPDOWN: { color: chalk.yellow, emoji: 'üìã', label: 'DROPDOWN' },
            INTERACTION: { color: chalk.magenta, emoji: 'üéØ', label: 'INTERACTION' },
            
            // Ïõπ Í¥ÄÎ†®
            WEB: { color: chalk.blue, emoji: 'üåê', label: 'WEB' },
            API: { color: chalk.cyan, emoji: 'üîå', label: 'API' },
            ROUTE: { color: chalk.green, emoji: 'üõ£Ô∏è', label: 'ROUTE' },
            AUTH: { color: chalk.yellow, emoji: 'üîê', label: 'AUTH' },
            SESSION: { color: chalk.magenta, emoji: 'üîë', label: 'SESSION' },
            
            // Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ†®
            DATABASE: { color: chalk.green, emoji: 'üíæ', label: 'DATABASE' },
            CACHE: { color: chalk.cyan, emoji: 'üíø', label: 'CACHE' },
            FILE: { color: chalk.blue, emoji: 'üìÅ', label: 'FILE' },
            SAVE: { color: chalk.green, emoji: 'üíæ', label: 'SAVE' },
            LOAD: { color: chalk.yellow, emoji: 'üìÇ', label: 'LOAD' },
            
            // Î≥¥Ïïà Í¥ÄÎ†®
            SECURITY: { color: chalk.red, emoji: 'üîí', label: 'SECURITY' },
            PERMISSION: { color: chalk.yellow, emoji: 'üõ°Ô∏è', label: 'PERMISSION' },
            ACCESS: { color: chalk.blue, emoji: 'üö™', label: 'ACCESS' },
            
            // ÏÑ±Îä• Í¥ÄÎ†®
            PERFORMANCE: { color: chalk.magenta, emoji: '‚ö°', label: 'PERFORMANCE' },
            MEMORY: { color: chalk.cyan, emoji: 'üß†', label: 'MEMORY' },
            CPU: { color: chalk.yellow, emoji: 'üíª', label: 'CPU' },
            
            // ÎÑ§Ìä∏ÏõåÌÅ¨ Í¥ÄÎ†®
            NETWORK: { color: chalk.blue, emoji: 'üåç', label: 'NETWORK' },
            REQUEST: { color: chalk.green, emoji: 'üì®', label: 'REQUEST' },
            RESPONSE: { color: chalk.cyan, emoji: 'üì¨', label: 'RESPONSE' },
            
            // Discord Í¥ÄÎ†®
            DISCORD: { color: chalk.hex('#5865F2'), emoji: 'üí¨', label: 'DISCORD' },
            GUILD: { color: chalk.green, emoji: 'üè∞', label: 'GUILD' },
            MEMBER: { color: chalk.blue, emoji: 'üë•', label: 'MEMBER' },
            VOICE: { color: chalk.yellow, emoji: 'üé§', label: 'VOICE' },
            
            // ÎîîÎ≤ÑÍ∑∏
            DEBUG: { color: chalk.gray, emoji: 'üîç', label: 'DEBUG' },
            TRACE: { color: chalk.dim, emoji: 'üîé', label: 'TRACE' }
        };
        
        this.history = [];
        this.maxHistory = 1000;
        
        // Î°úÍ∑∏ ÌååÏùº ÏÑ§Ï†ï
        this.logDir = path.join(process.cwd(), 'logs');
        this.ensureLogDirectory();
    }
    
    ensureLogDirectory() {
        if (!fs.existsSync(this.logDir)) {
            fs.mkdirSync(this.logDir, { recursive: true });
        }
    }
    
    getTimestamp() {
        return new Date().toLocaleString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }
    
    log(type, message, ...args) {
        const logType = this.logTypes[type] || this.logTypes.INFO;
        const timestamp = this.getTimestamp();
        const formattedMessage = this.formatMessage(logType, message, args);
        
        // ÏΩòÏÜî Ï∂úÎ†•
        console.log(formattedMessage);
        
        // ÌûàÏä§ÌÜ†Î¶¨ Ï†ÄÏû•
        this.addToHistory({
            timestamp,
            type,
            message,
            args
        });
        
        // ÌååÏùº Ï†ÄÏû•
        this.saveToFile(timestamp, type, message, args);
    }
    
    formatMessage(logType, message, args = []) {
        const { emoji, color, label } = logType;
        const timestamp = `[${this.getTimestamp()}]`;
        const extraInfo = args.length > 0 ? chalk.gray(` | ${args.join(' | ')}`) : '';
        
        return `${timestamp} ${emoji} ${color(`[${label}]`)} ${message}${extraInfo}`;
    }
    
    addToHistory(entry) {
        this.history.push(entry);
        if (this.history.length > this.maxHistory) {
            this.history.shift();
        }
    }
    
    getHistory(type = null, limit = 100) {
        let filtered = this.history;
        
        if (type) {
            filtered = this.history.filter(entry => entry.type === type);
        }
        
        return filtered.slice(-limit);
    }
    
    saveToFile(timestamp, type, message, args) {
        const date = new Date().toISOString().split('T')[0];
        const filename = path.join(this.logDir, `${date}.log`);
        const logEntry = `[${timestamp}] [${type}] ${message} ${args.join(' ')}\n`;
        
        fs.appendFile(filename, logEntry, (err) => {
            if (err) {
                console.error('Î°úÍ∑∏ ÌååÏùº Ï†ÄÏû• Ïã§Ìå®:', err);
            }
        });
    }
    
    // Ìé∏Ïùò Î©îÏÑúÎìúÎì§
    system(message, ...args) {
        this.log('SYSTEM', message, ...args);
    }
    
    startup(message, ...args) {
        this.log('STARTUP', message, ...args);
    }
    
    ready(message, ...args) {
        this.log('READY', message, ...args);
    }
    
    shutdown(message, ...args) {
        this.log('SHUTDOWN', message, ...args);
    }
    
    info(message, ...args) {
        this.log('INFO', message, ...args);
    }
    
    success(message, ...args) {
        this.log('SUCCESS', message, ...args);
    }
    
    warning(message, ...args) {
        this.log('WARNING', message, ...args);
    }
    
    warn(message, ...args) {
        this.warning(message, ...args);
    }
    
    error(message, ...args) {
        this.log('ERROR', message, ...args);
    }
    
    critical(message, ...args) {
        this.log('CRITICAL', message, ...args);
    }
    
    module(message, ...args) {
        this.log('MODULE', message, ...args);
    }
    
    moduleLoad(message, ...args) {
        this.log('MODULE_LOAD', message, ...args);
    }
    
    moduleUnload(message, ...args) {
        this.log('MODULE_UNLOAD', message, ...args);
    }
    
    moduleError(message, ...args) {
        this.log('MODULE_ERROR', message, ...args);
    }
    
    event(message, ...args) {
        this.log('EVENT', message, ...args);
    }
    
    command(message, ...args) {
        this.log('COMMAND', message, ...args);
    }
    
    button(message, ...args) {
        this.log('BUTTON', message, ...args);
    }
    
    dropdown(message, ...args) {
        this.log('DROPDOWN', message, ...args);
    }
    
    interaction(message, ...args) {
        this.log('INTERACTION', message, ...args);
    }
    
    web(message, ...args) {
        this.log('WEB', message, ...args);
    }
    
    api(message, ...args) {
        this.log('API', message, ...args);
    }
    
    route(message, ...args) {
        this.log('ROUTE', message, ...args);
    }
    
    auth(message, ...args) {
        this.log('AUTH', message, ...args);
    }
    
    session(message, ...args) {
        this.log('SESSION', message, ...args);
    }
    
    database(message, ...args) {
        this.log('DATABASE', message, ...args);
    }
    
    cache(message, ...args) {
        this.log('CACHE', message, ...args);
    }
    
    file(message, ...args) {
        this.log('FILE', message, ...args);
    }
    
    save(message, ...args) {
        this.log('SAVE', message, ...args);
    }
    
    load(message, ...args) {
        this.log('LOAD', message, ...args);
    }
    
    security(message, ...args) {
        this.log('SECURITY', message, ...args);
    }
    
    permission(message, ...args) {
        this.log('PERMISSION', message, ...args);
    }
    
    access(message, ...args) {
        this.log('ACCESS', message, ...args);
    }
    
    performance(message, ...args) {
        this.log('PERFORMANCE', message, ...args);
    }
    
    memory(message, ...args) {
        this.log('MEMORY', message, ...args);
    }
    
    cpu(message, ...args) {
        this.log('CPU', message, ...args);
    }
    
    network(message, ...args) {
        this.log('NETWORK', message, ...args);
    }
    
    request(message, ...args) {
        this.log('REQUEST', message, ...args);
    }
    
    response(message, ...args) {
        this.log('RESPONSE', message, ...args);
    }
    
    discord(message, ...args) {
        this.log('DISCORD', message, ...args);
    }
    
    guild(message, ...args) {
        this.log('GUILD', message, ...args);
    }
    
    member(message, ...args) {
        this.log('MEMBER', message, ...args);
    }
    
    voice(message, ...args) {
        this.log('VOICE', message, ...args);
    }
    
    debug(message, ...args) {
        if (process.env.DEBUG === 'true') {
            this.log('DEBUG', message, ...args);
        }
    }
    
    trace(message, ...args) {
        if (process.env.TRACE === 'true') {
            this.log('TRACE', message, ...args);
        }
    }
    
    // ÌÖåÏù¥Î∏î ÌòïÏãù Ï∂úÎ†•
    table(data, title = '') {
        if (title) {
            console.log(chalk.bold.underline(`\n${title}`));
        }
        console.table(data);
    }
    
    // Íµ¨Î∂ÑÏÑ†
    separator(char = '‚îÄ', length = 50) {
        console.log(chalk.gray(char.repeat(length)));
    }
    
    // Î∞∞ÎÑà
    banner(text, color = chalk.cyan) {
        const border = '‚ïê'.repeat(text.length + 4);
        console.log(color(`‚ïî${border}‚ïó`));
        console.log(color(`‚ïë  ${chalk.bold(text)}  ‚ïë`));
        console.log(color(`‚ïö${border}‚ïù`));
    }
    
    // ÌîÑÎ°úÍ∑∏Î†àÏä§ Î∞î
    progress(current, total, label = '') {
        const percentage = Math.round((current / total) * 100);
        const filled = Math.round((current / total) * 20);
        const empty = 20 - filled;
        const bar = `${'‚ñà'.repeat(filled)}${'‚ñë'.repeat(empty)}`;
        const message = `${label} [${bar}] ${percentage}% (${current}/${total})`;
        
        // Í∞ôÏùÄ Ï§ÑÏóê ÏóÖÎç∞Ïù¥Ìä∏
        process.stdout.write(`\r${message}`);
        
        if (current === total) {
            console.log(); // ÏôÑÎ£å Ïãú Ï§ÑÎ∞îÍøà
        }
    }
    
    // Î∞ïÏä§ Ï∂úÎ†•
    box(content, title = '', color = chalk.white) {
        const lines = content.split('\n');
        const maxLength = Math.max(...lines.map(line => line.length), title.length);
        const width = maxLength + 4;
        
        console.log(color(`‚îå${'‚îÄ'.repeat(width)}‚îê`));
        
        if (title) {
            const padding = Math.floor((width - title.length - 2) / 2);
            console.log(color(`‚îÇ${' '.repeat(padding)}${chalk.bold(title)}${' '.repeat(width - padding - title.length - 2)}‚îÇ`));
            console.log(color(`‚îú${'‚îÄ'.repeat(width)}‚î§`));
        }
        
        lines.forEach(line => {
            const padding = width - line.length - 2;
            console.log(color(`‚îÇ ${line}${' '.repeat(padding)} ‚îÇ`));
        });
        
        console.log(color(`‚îî${'‚îÄ'.repeat(width)}‚îò`));
    }
}

module.exports = new Logger();